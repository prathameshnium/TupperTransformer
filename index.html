<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TupperTransformer Demo (v7)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Add MathJax for math rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Keep canvas pixels sharp and crisp when scaled */
        canvas {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            width: 100%;
            aspect-ratio: 1060 / 170; /* Use the new native resolution */
            background-color: #f0f0f0;
            /* Add a border to the canvas itself */
            border: 1px solid #ccc;
        }
        /* Style canvas when draw mode is active */
        canvas.draw-mode-active {
            cursor: crosshair;
        }

        /* Simple syntax highlighting for the BibTeX block */
        pre[class*="language-"] {
            padding: 1em;
            margin: .5em 0;
            overflow: auto;
            border-radius: 0.3em;
            background: #fdf6e3; /* Solarized Light */
            color: #657b83;
        }
        .token.comment, .token.prolog, .token.doctype, .token.cdata { color: #93a1a1; }
        .token.punctuation { color: #657b83; }
        .token.property, .token.tag, .token.boolean, .token.number, .token.constant, .token.symbol, .token.deleted { color: #cb4b16; }
        .token.selector, .token.attr-name, .token.string, .token.char, .token.builtin, .token.inserted { color: #2aa198; }
        .token.operator, .token.entity, .token.url, .language-css .token.string, .style .token.string { color: #d33682; }
        .token.atrule, .token.attr-value, .token.keyword { color: #859900; }
        .token.function, .token.class-name { color: #b58900; }
        .token.regex, .token.important, .token.variable { color: #cb4b16; }

        /* Styles for the new "tab" buttons */
        .tab-button {
            @apply w-full font-semibold py-3 px-4 rounded-lg transition-colors shadow-sm text-gray-700 bg-gray-200 hover:bg-gray-300;
        }
        .tab-button[aria-selected="true"] {
            @apply text-white;
        }
        /* Specific active colors for each tab */
        #btnTransformTab[aria-selected="true"] {
            @apply bg-indigo-600;
        }
        #btnLoadTab[aria-selected="true"] {
            @apply bg-orange-600;
        }
         #btnDrawTab[aria-selected="true"] {
            @apply bg-green-600;
        }
        #btnExamplesTab[aria-selected="true"] {
            @apply bg-blue-600;
        }
        /* Add user-select-none to prevent text highlighting when rapidly clicking/holding buttons */
        .manual-anim-button {
            @apply select-none;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex items-center justify-center font-sans">

    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-6xl relative">
        
        <!-- GitHub Link -->
        <a href="https://github.com/prathameshnium/TupperTransformer" target="_blank" rel="noopener noreferrer" title="View on GitHub" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
        
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">TupperTransformer</h1>
        <p class="text-center text-gray-600 mb-6">
            An interactive demo of my Tupper's function transformation algorithm (<a href="https://figshare.com/articles/preprint/Transformation_of_pixels_pdf/6373046/2?file=11711468" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">pre-print @ 2018</a>), -Prathamesh Deshmukh.
        </p>
        <div class="text-center text-gray-600 mb-6 text-lg" id="tupper-formula">
            $$ \frac{1}{2} < \left\lfloor \operatorname{mod}\left(\left\lfloor \frac{y}{17} \right\rfloor 2^{-17\lfloor x \rfloor - \operatorname{mod}(\lfloor y \rfloor, 17)}, 2\right) \right\rfloor $$
        </div>

        <!-- "Read More" Button & Summary Link -->
        <div class="text-center mb-6">
            <button id="btnReadMore" class="text-blue-600 font-medium hover:underline focus:outline-none">Read more about this project</button>
            <!-- NEW LINK to README -->
            <span class="mx-2 text-gray-400">|</span>
            <a href="https://github.com/prathameshnium/TupperTransformer/blob/main/README.md" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-medium hover:underline focus:outline-none">Quick summary of the paper</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8">
            <!-- Left Column -->
            <div class="md:col-span-2">
                <div class="bg-gray-200 rounded-lg p-2 overflow-hidden">
                    <canvas id="tupperCanvas" width="1060" height="170"></canvas>
                </div>

                <!-- Transform Controls -->
                <div class="mt-6 p-4 border border-gray-200 bg-white rounded-lg">
                    <h3 class="text-md font-semibold text-gray-800 mb-4 text-center">Transform Pattern</h3>
                    <p class="text-xs text-gray-500 text-center mb-3">Hold buttons to move the pattern on the canvas.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btnMoveUp" class="manual-anim-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Move Up</button>
                        <button id="btnMoveDown" class="manual-anim-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Move Down</button>
                        <button id="btnMoveLeft" class="manual-anim-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Move Left</button>
                        <button id="btnMoveRight" class="manual-anim-button bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Move Right</button>
                        <button id="btnMoveDiagUpRight" class="manual-anim-button col-span-2 bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Move Diag (Up-Right)</button>
                        <button id="btnStopManualAnim" class="col-span-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 transition-colors hidden">Stop Manual Animation</button>
                    </div>
                </div>

                <!-- K-Value Input -->
                <div class="mt-6">
                    <label for="k_value" class="block text-sm font-medium text-gray-700">Current K-Value:</label>
                    <textarea id="k_value" rows="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-xs"></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="md:col-span-1 space-y-6">
                <!-- Accordion Item 1: Demos & Examples -->
                <div>
                    <h2 id="accordion-heading-1">
                        <button type="button" class="accordion-button flex items-center justify-between w-full p-5 font-medium text-left text-gray-700 bg-gray-100 border border-gray-200 rounded-t-xl hover:bg-gray-200" data-accordion-target="#accordion-body-1" aria-expanded="true" aria-controls="accordion-body-1">
                            <span>1. Demos & Examples</span>
                            <svg class="w-6 h-6 rotate-180 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </h2>
                    <div id="accordion-body-1" class="p-5 border border-t-0 border-gray-200">
                        <p class="mb-4 text-sm text-gray-600">Load a pre-defined pattern or watch a demo.</p>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btnLoadTupper" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 transition-colors shadow-sm">Load Tupper's</button>
                            <button id="btnLoadUFOCenter" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 transition-colors shadow-sm">Load UFO (Center)</button>
                        </div>
                        <hr class="my-6 border-gray-300">
                        <div class="p-4 border border-blue-200 bg-blue-50 rounded-lg text-center mb-6">
                             <h3 class="text-lg font-semibold text-blue-800 mb-4">Animation Demo (Eg3.1)</h3>
                             <p class="text-blue-700 mb-4 text-sm">Plays the "Top-Left UFO" animation from the paper.</p>
                             <button id="btnToggleUFOAnim" class="w-full md:w-1/2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors shadow-sm">Play UFO Animation</button>
                        </div>
                        <div class="p-4 border border-orange-200 bg-orange-50 rounded-lg">
                             <h3 class="text-lg font-semibold text-orange-800 mb-4 text-center">Interactive Tetris (Eg3.2)</h3>
                             <div class="text-center mb-4">
                                 <button id="btnLoadTetris" class="w-full md:w-1/2 bg-orange-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-orange-600 transition-colors shadow-sm">Load Tetris Example</button>
                             </div>
                             <p class="text-orange-700 mb-4 text-sm text-center">After loading, use these buttons to transform the L-piece (ks) independently from the resting pieces (kr).</p>
                             <div class="grid grid-cols-3 gap-3 mt-4 max-w-md mx-auto">
                                <button id="btnTetrisMoveLeft" class="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Piece Left</button>
                                <button id="btnTetrisMoveDown" class="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Piece Down</button>
                                <button id="btnTetrisMoveRight" class="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 transition-colors">Piece Right</button>
                             </div>
                        </div>
                        <div class="p-4 border border-purple-200 bg-purple-50 rounded-lg text-center mt-6">
                             <h3 class="text-lg font-semibold text-purple-800 mb-4">Library of Babel</h3>
                             <p class="text-purple-700 mb-4 text-sm">Continuously generates random K-values.</p>
                             <button id="btnToggleBabel" class="w-full md:w-1/2 bg-purple-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-700 transition-colors shadow-sm">Start Library of Babel</button>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 2: Draw -->
                <div>
                    <h2 id="accordion-heading-2">
                        <button type="button" class="accordion-button flex items-center justify-between w-full p-5 font-medium text-left text-gray-500 border border-gray-200 hover:bg-gray-200" data-accordion-target="#accordion-body-2" aria-expanded="false" aria-controls="accordion-body-2">
                            <span>2. Draw Your Own</span>
                            <svg class="w-6 h-6 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </h2>
                    <div id="accordion-body-2" class="hidden p-5 border border-t-0 border-gray-200">
                        <p class="mb-4 text-sm text-gray-600">Drawing is enabled by default. Click the button to disable it.</p>
                        <button id="btnEnableDraw" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition-colors shadow-sm">Enable Draw Mode</button>
                        <button id="btnClearCanvas" class="w-full mt-3 bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition-colors shadow-sm">Clear Canvas</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- "About" Modal -->
    <div id="aboutModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden transition-opacity duration-300 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <!-- Close Button -->
            <button id="btnCloseModal" class="absolute top-4 right-5 text-gray-400 hover:text-gray-700 text-3xl font-bold focus:outline-none" title="Close">&times;</button>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4">About TupperTransformer</h2>
            
            <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-800">Abstract</h3>
            <p class="text-gray-700 mb-4 italic">
                "My research idea start with a question that if there is some graphical formation at a particular value of k then what can do to change the graphical formation or to change its position. In his research paper, I have shown that:
            </p>
            <ul class="list-disc list-inside space-y-2 mb-4 text-gray-700 italic">
                <li>How to change any graphical formation into other graphical formation by applying some kind of operation to the value of the k</li>
                <li>How can this different graphical formation be used as a frame to create a film/motion picture</li>
            </ul>

            <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-800">The Core Algorithm (My Original Research)</h3>
            <p class="text-gray-700 mb-4">
                The technical paper that this project implements is my 2018 preprint, which provides the complete mathematical foundation for these operations.
            </p>
            <ul class="list-none mb-4 space-y-2 bg-gray-50 p-4 rounded-md border">
                <li><strong class="text-gray-800">Paper:</strong> "Transformation of the pixels in Tupper's self-referential formula"</li>
                <li><strong class="text-gray-800">Author:</strong> Prathamesh Deshmukh (Me)</li>
                <li><strong class="text-gray-800">Publication Date:</strong> May 24, 2018</li>
            </ul>

            <p class="text-gray-700 mb-4">
                The core idea I explored in the paper is that any graphical formation plotted by Tupper's formula (in the $106 \times 17$ grid) can be transformed by applying arithmetic operations directly to the `k` constant.
            </p>
            <p class="text-gray-700 mb-4">This algorithm allows for precise transformations, including:</p>
            
            <ul class="list-none space-y-4 mb-4 text-gray-700">
                <li>
                    <strong class="text-gray-800 block">Pixel Manipulation:</strong>
                    Adding or removing any individual pixel `i` by adding or subtracting the value $17 \times 2^{i-1}$ from the `k` constant. (Equation C)
                </li>
                <li>
                    <strong class="text-gray-800 block">Spatial Translation (Moving):</strong>
                    <ul class="list-disc list-inside ml-6 mt-2 space-y-1">
                        <li><strong>Up/Down:</strong> Moving the entire image `n` pixels up or down by multiplying or dividing `k` by $2^n$.</li>
                        <li><strong>Left/Right:</strong> Moving the entire image `n` pixels left or right by multiplying or dividing `k` by $2^{n \times 17}$.</li>
                    </ul>
                </li>
            </ul>

            
            <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-800">How to Use This Demo</h3>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Select a mode: Transform & Load, Draw, or Demos & Examples.</li>
                <li>The demo will load the relevant example from my paper or a blank canvas.</li>
                <li>Use the contextual controls for each mode to transform the image.</li>
                <li>See the resulting `k` value and the updated image in real-time.</li>
            </Ssol>

            <h3 class="text-xl font-semibold mt-6 mb-3 text-gray-800">Citation & Publication History</h3>
            
            <!-- REMOVED iFrame -->

            <h4 class="text-lg font-semibold mt-6 mb-2 text-gray-800">BibTeX Citation (Recommended)</h4>
            <pre class="language-bibtex rounded-lg"><code>@article{Deshmukh2018,
  author = "P Deshmukh",
  title = "{Transformation of the pixels in tupper's self-referential formula}",
  year = "2018",
  month = "6",
  url = "https://figshare.com/articles/preprint/Transformation_of_pixels_pdf/6373046",
  doi = "10.6084/m9.figshare.6373046.v2"
}</code></pre>

            <h4 class="text-lg font-semibold mt-6 mb-2 text-gray-800">Indexing &amp; Archives</h4>
            <div class="mt-4 space-y-3">
                <div class="bg-gray-50 p-3 rounded-md border">
                    <p class="font-semibold text-gray-800">Preferred Version (Figshare v2)</p>
                    <p class="text-sm text-gray-600">Deshmukh, P. (2018). <i>Transformation of the pixels in Tupper's self-referential formula</i>. Figshare. (DOI: 10.6084/m9.figshare.6373046)</p>
                    <p class="text-sm text-gray-600 mt-1"><strong>First Posted:</strong> June 08, 2018</p>
                    <a href="https://doi.org/10.6084/m9.figshare.6373046" target="_blank" rel="noopener noreferrer" class="text-blue-600 text-sm hover:underline break-all mt-1 block">https://doi.org/10.6084/m9.figshare.6373046</a>
                    <!-- NEW: Full Article Link -->
                    <a href="https://figshare.com/articles/preprint/Transformation_of_pixels_pdf/6373046/2?file=11711468" target="_blank" rel="noopener noreferrer" class="text-green-700 text-sm font-semibold hover:underline mt-2 block">
                        &rarr; Access the full article here
                    </a>
                </div>

                <div class="bg-gray-50 p-3 rounded-md border">
                    <p class="font-semibold text-gray-800">Semantic Scholar Index</p>
                    <a href="https://www.semanticscholar.org/paper/Transformation-of-the-Pixels-in-Tupper's-Formula-Deshmukh/f7f02b429a5fcdc20a29410226c73eecaf992541" target="_blank" rel="noopener noreferrer" class="text-blue-600 text-sm hover:underline break-all">https://www.semanticscholar.org/paper/Transformation-of-the-Pixels-in-Tupper's-Formula-Deshmukh/f7f02b429a5fcdc20a29410226c73eecaf992541</a>
                </div>

                <div class="bg-gray-50 p-3 rounded-md border">
                    <p class="font-semibold text-gray-800">Internet Archive (Archive of v1)</p>
                    <a href="https://web.archive.org/web/20200220095114/https://s3-eu-west-1.amazonaws.com/pfigshare-u-files/11711468/Transformation_of_pixels.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-600 text-sm hover:underline break-all">httpsE://web.archive.org/web/20200220095114/https://s3-eu-west-1.amazonaws.com/pfigshare-u-files/11711468/Transformation_of_pixels.pdf</a>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Accordion Logic ---
            const accordionButtons = document.querySelectorAll('.accordion-button');
            accordionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const isExpanded = button.getAttribute('aria-expanded') === 'true';
                    
                    // Close all accordion bodies
                    accordionButtons.forEach(b => {
                        b.setAttribute('aria-expanded', 'false');
                        document.querySelector(b.dataset.accordionTarget).classList.add('hidden');
                        b.querySelector('svg').classList.remove('rotate-180');
                    });

                    // Open the clicked one if it was closed
                    if (!isExpanded) {
                        button.setAttribute('aria-expanded', 'true');
                        document.querySelector(button.dataset.accordionTarget).classList.remove('hidden');
                        button.querySelector('svg').classList.add('rotate-180');
                    }
                });
            });

            // --- Canvas & K-Value Elements ---
            const canvas = document.getElementById('tupperCanvas');
            const ctx = canvas.getContext('2d');
            const textarea = document.getElementById('k_value');

            // --- Modal Elements ---
            const btnReadMore = document.getElementById('btnReadMore');
            const aboutModal = document.getElementById('aboutModal');
            const btnCloseModal = document.getElementById('btnCloseModal');

            // --- Control Buttons ---
            const btnLoadTupper = document.getElementById('btnLoadTupper');
            const btnLoadUFOCenter = document.getElementById('btnLoadUFOCenter');
            const btnEnableDraw = document.getElementById('btnEnableDraw');
            const btnClearCanvas = document.getElementById('btnClearCanvas');
            const btnToggleUFOAnim = document.getElementById('btnToggleUFOAnim');
            const btnToggleBabel = document.getElementById('btnToggleBabel');
            const btnLoadTetris = document.getElementById('btnLoadTetris');
            const btnTetrisMoveLeft = document.getElementById('btnTetrisMoveLeft');
            const btnTetrisMoveRight = document.getElementById('btnTetrisMoveRight');
            const btnTetrisMoveDown = document.getElementById('btnTetrisMoveDown');
            const btnMoveUp = document.getElementById('btnMoveUp');
            const btnMoveDown = document.getElementById('btnMoveDown');
            const btnMoveLeft = document.getElementById('btnMoveLeft');
            const btnMoveRight = document.getElementById('btnMoveRight');
            const btnMoveDiagUpRight = document.getElementById('btnMoveDiagUpRight');
            const manualAnimButtons = [btnMoveUp, btnMoveDown, btnMoveLeft, btnMoveRight, btnMoveDiagUpRight];
            const btnStopManualAnim = document.getElementById('btnStopManualAnim');

            // --- Constants ---
            const GRID_WIDTH = 106;
            const GRID_HEIGHT = 17;
            const PIXEL_SCALE = 10;
            const H_BIGINT = BigInt(GRID_HEIGHT);
            const OFF_PIXEL_COLOR = '#f0f0f0';
            const ON_PIXEL_COLOR = '#000000';
            const GRID_COLOR = '#ccc';
            const ANIMATION_SPEED = 150;
            const LATCH_TIME = 500;
            
            const TUPPER_K = 960939379918958884971672962127852754715004339660129306651505519271702802395266424689642842174350718121267153782770623355993237280874144307891325963941337723487857735749823926629715517173716995165232890538221612403238855866184013235585136048828693337902491454229288667081096184496091705183454067827731551705405381627380967602565625016981482083418783163849115590225610003652351370343874461848378737238198224849863465033159410054974700593138339226497249461751545728366702369745461014655997933798537483143786841806593422227898388722980000748404719n;
            const UFO_CENTER_K = 443352924415299750269935582831006891736908292088519263818614474851967119874782775886465719557549939463756309785941884807127269950858601139076519485343718480093603142421094905794300356122213456551693296459008206217500505569300664030340014779960166914732789553875507120518890769928117177323414356728568578317831865211788253557426913017856n;
            const UFO_TOP_LEFT_K = 3364095144409490406402517685013936223230541008369211472154153567830130294784n;
            const KR_BIGINT = 1465173377163840840964195200776229452338097479160165100993321673778726174973516467105018733852068234022255298658975702245055915087238316041012593947856673785182723705258476099103213618090667396472262335593747367067648n;
            const KS_BIGINT = 42640449639783743164699946138133627753613984093735772109827003226441916669711823327553649089932323504047296961434448619137954569794030245783793507114789257497126216466424824493834668782237110139139800432640n;

            // --- State ---
            let ufoAnimationInterval = null;
            let babelAnimationInterval = null;
            let manualAnimationInterval = null;
            let manualAnimationTimer = null;
            let isManualAnimationLatched = false;
            let currentTetrisPieceK = 0n;
            let isDrawing = false;
            let drawnPixels = new Set();
            let currentK = 0n;

            // --- Core Functions ---
            function drawGrid(k) {
                if (typeof k !== 'bigint') {
                    console.error("drawGrid requires a BigInt");
                    return;
                }
                currentK = k;
                ctx.fillStyle = OFF_PIXEL_COLOR;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const k_div_17 = k / H_BIGINT;
                ctx.strokeStyle = GRID_COLOR;
                ctx.lineWidth = 1;
                for (let x = 0; x < GRID_WIDTH; x++) {
                    for (let y = 0; y < GRID_HEIGHT; y++) {
                        const bit_position = BigInt(x * GRID_HEIGHT + y);
                        const bit = (k_div_17 >> bit_position) & 1n;
                        const drawX = x * PIXEL_SCALE;
                        const drawY = (GRID_HEIGHT - 1 - y) * PIXEL_SCALE;
                        if (bit === 1n) {
                            ctx.fillStyle = ON_PIXEL_COLOR;
                            ctx.fillRect(drawX, drawY, PIXEL_SCALE, PIXEL_SCALE);
                        }
                        ctx.strokeRect(drawX, drawY, PIXEL_SCALE, PIXEL_SCALE);
                    }
                }
            }

            function getCurrentK() {
                try {
                    const k_string = textarea.value.replace(/\s/g, '').replace('n', '');
                    if (k_string === "") return 0n;
                    return BigInt(k_string);
                } catch (e) {
                    alert("Invalid K-Value. It must be a valid (very large) integer.");
                    return null;
                }
            }

            function updateK(newK) {
                textarea.value = newK.toString();
                currentK = newK;
            }

            function stopAllAnimations() {
                if (ufoAnimationInterval) clearInterval(ufoAnimationInterval);
                ufoAnimationInterval = null;
                if (babelAnimationInterval) clearInterval(babelAnimationInterval);
                babelAnimationInterval = null;
                btnToggleUFOAnim.textContent = "Play UFO Animation";
                btnToggleBabel.textContent = "Start Library of Babel";
                forceStopManualAnimation();
            }
            
            // --- Modal ---
            btnReadMore.addEventListener('click', () => aboutModal.classList.remove('hidden'));
            btnCloseModal.addEventListener('click', () => aboutModal.classList.add('hidden'));
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) aboutModal.classList.add('hidden');
            });

            // --- Control Logic ---
            btnLoadTupper.addEventListener('click', () => {
                stopAllAnimations();
                updateK(TUPPER_K);
                drawGrid(TUPPER_K);
            });
            btnLoadUFOCenter.addEventListener('click', () => {
                stopAllAnimations();
                updateK(UFO_CENTER_K);
                drawGrid(UFO_CENTER_K);
            });

            // --- Draw Mode ---
            function setDrawMode(enabled) {
                isDrawing = false;
                if (enabled) {
                    canvas.classList.add('draw-mode-active');
                    btnEnableDraw.textContent = 'Disable Draw Mode';
                    btnEnableDraw.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btnEnableDraw.classList.add('bg-red-500', 'hover:bg-red-600');
                } else {
                    canvas.classList.remove('draw-mode-active');
                    btnEnableDraw.textContent = 'Enable Draw Mode';
                    btnEnableDraw.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btnEnableDraw.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            }
            btnEnableDraw.addEventListener('click', () => {
                const isDrawActive = canvas.classList.contains('draw-mode-active');
                setDrawMode(!isDrawActive);
            });
            btnClearCanvas.addEventListener('click', () => {
                stopAllAnimations();
                updateK(0n);
                drawGrid(0n);
            });

            // --- Demos ---
            btnToggleUFOAnim.addEventListener('click', () => {
                if (ufoAnimationInterval) {
                    stopAllAnimations();
                } else {
                    stopAllAnimations();
                    let tempK = UFO_TOP_LEFT_K;
                    updateK(tempK);
                    drawGrid(tempK);
                    ufoAnimationInterval = setInterval(() => {
                        tempK *= (2n ** H_BIGINT);
                        updateK(tempK);
                        drawGrid(tempK);
                    }, 300);
                    btnToggleUFOAnim.textContent = "Stop Animation";
                }
            });
            btnLoadTetris.addEventListener('click', () => {
                stopAllAnimations();
                currentTetrisPieceK = KS_BIGINT;
                const totalK = KR_BIGINT + currentTetrisPieceK;
                updateK(totalK);
                drawGrid(totalK);
            });
            btnTetrisMoveLeft.addEventListener('click', () => {
                currentTetrisPieceK /= (2n ** H_BIGINT);
                drawGrid(KR_BIGINT + currentTetrisPieceK);
            });
            btnTetrisMoveRight.addEventListener('click', () => {
                currentTetrisPieceK *= (2n ** H_BIGINT);
                drawGrid(KR_BIGINT + currentTetrisPieceK);
            });
            btnTetrisMoveDown.addEventListener('click', () => {
                currentTetrisPieceK /= 2n;
                drawGrid(KR_BIGINT + currentTetrisPieceK);
            });

            function getRandomK() {
                let k_string = '';
                const num_digits = 537;
                for (let i = 0; i < num_digits; i++) {
                    k_string += Math.floor(Math.random() * 10);
                }
                return BigInt(k_string);
            }

            btnToggleBabel.addEventListener('click', () => {
                if (babelAnimationInterval) {
                    stopAllAnimations();
                } else {
                    stopAllAnimations();
                    babelAnimationInterval = setInterval(() => {
                        const randomK = getRandomK();
                        updateK(randomK);
                        drawGrid(randomK);
                    }, 200);
                    btnToggleBabel.textContent = "Stop Library of Babel";
                }
            });

            // --- Manual Transform ---
            function startManualAnimation(transformFunction) {
                stopAllAnimations();
                isManualAnimationLatched = false;
                let k = getCurrentK();
                if (k === null) return;
                k = transformFunction(k);
                updateK(k);
                drawGrid(k);
                manualAnimationInterval = setInterval(() => {
                    k = transformFunction(getCurrentK());
                    k = transformFunction(k);
                    updateK(k);
                    drawGrid(k);
                }, ANIMATION_SPEED);
                manualAnimationTimer = setTimeout(() => {
                    isManualAnimationLatched = true;
                    btnStopManualAnim.classList.remove('hidden');
                }, LATCH_TIME);
            }
            function stopManualAnimation() {
                if (isManualAnimationLatched) return;
                if (manualAnimationInterval) clearInterval(manualAnimationInterval);
                if (manualAnimationTimer) clearTimeout(manualAnimationTimer);
                manualAnimationInterval = null;
                manualAnimationTimer = null;
            }
            function forceStopManualAnimation() {
                if (manualAnimationInterval) clearInterval(manualAnimationInterval);
                if (manualAnimationTimer) clearTimeout(manualAnimationTimer);
                manualAnimationInterval = null;
                manualAnimationTimer = null;
                isManualAnimationLatched = false;
                btnStopManualAnim.classList.add('hidden');
            }
            const transformUp = (k) => k * 2n;
            const transformDown = (k) => k / 2n;
            const transformLeft = (k) => k / (2n ** H_BIGINT);
            const transformRight = (k) => k * (2n ** H_BIGINT);
            const transformDiag = (k) => (k * (2n ** H_BIGINT)) * 2n;
            const stopEvents = ['mouseup', 'mouseleave', 'touchend'];
            btnMoveUp.addEventListener('mousedown', () => startManualAnimation(transformUp));
            btnMoveUp.addEventListener('touchstart', (e) => { e.preventDefault(); startManualAnimation(transformUp); });
            btnMoveDown.addEventListener('mousedown', () => startManualAnimation(transformDown));
            btnMoveDown.addEventListener('touchstart', (e) => { e.preventDefault(); startManualAnimation(transformDown); });
            btnMoveLeft.addEventListener('mousedown', () => startManualAnimation(transformLeft));
            btnMoveLeft.addEventListener('touchstart', (e) => { e.preventDefault(); startManualAnimation(transformLeft); });
            btnMoveRight.addEventListener('mousedown', () => startManualAnimation(transformRight));
            btnMoveRight.addEventListener('touchstart', (e) => { e.preventDefault(); startManualAnimation(transformRight); });
            btnMoveDiagUpRight.addEventListener('mousedown', () => startManualAnimation(transformDiag));
            btnMoveDiagUpRight.addEventListener('touchstart', (e) => { e.preventDefault(); startManualAnimation(transformDiag); });
            manualAnimButtons.forEach(button => {
                stopEvents.forEach(event => button.addEventListener(event, stopManualAnimation));
            });
            btnStopManualAnim.addEventListener('click', forceStopManualAnimation);

            // --- Canvas Drawing ---
            function handleDraw(event) {
                if (!canvas.classList.contains('draw-mode-active')) return;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                let clientX, clientY;
                if (event.touches) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                const x_canvas = (clientX - rect.left) * scaleX;
                const y_canvas = (clientY - rect.top) * scaleY;
                const x = Math.floor(x_canvas / PIXEL_SCALE);
                const y = (GRID_HEIGHT - 1) - Math.floor(y_canvas / PIXEL_SCALE);
                if (x < 0 || x >= GRID_WIDTH || y < 0 || y >= GRID_HEIGHT) return;
                const pixelKey = `${x},${y}`;
                if (isDrawing && drawnPixels.has(pixelKey)) return;
                drawnPixels.add(pixelKey);
                const bit_position = BigInt(x * GRID_HEIGHT + y);
                const value_to_change = H_BIGINT * (2n ** bit_position);
                const k_div_17 = getCurrentK() / H_BIGINT;
                const bit = (k_div_17 >> bit_position) & 1n;
                const newK = (bit === 1n) ? getCurrentK() - value_to_change : getCurrentK() + value_to_change;
                updateK(newK);
                drawGrid(newK);
            }
            function startDrawing(e) {
                if (!canvas.classList.contains('draw-mode-active')) return;
                e.preventDefault();
                isDrawing = true;
                drawnPixels.clear();
                handleDraw(e);
            }
            function draw(e) {
                if (!isDrawing || !canvas.classList.contains('draw-mode-active')) return;
                e.preventDefault();
                handleDraw(e);
            }
            function stopDrawing(e) {
                if (!canvas.classList.contains('draw-mode-active')) return;
                e.preventDefault();
                isDrawing = false;
                drawnPixels.clear();
            }
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);

            // --- Initial Load ---
            updateK(UFO_CENTER_K);
            drawGrid(UFO_CENTER_K);
            setDrawMode(true);
        });
    </script>